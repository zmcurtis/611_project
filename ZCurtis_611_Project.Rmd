---
title: "611 Project--Wine Quality Analysis"
author: "Zoe Curtis"
date: "2025-09-30"
output:
  pdf_document: default
---
# CONSIDER QUALITY SCORE -- include in analyses? use in separate analysis? maybe predict type with quality? 

This analysis will explore a concatenated data set containing chemical components of red and white variants of the Portuguese "Vinho Verde" wine from 2009. It contains chemical components including fixed acidity, volatile acidity, citric acid, residual sugar, chlorides, free sulfur dioxide, total sulfur dioxide, density, pH, sulphates, and alcohol. It also contains a quality score. I am interested in exploring whether wine type (red vs white) differs in their chemical composition, and whether there is a quality difference between the types. 

The data set was obtained at https://archive.ics.uci.edu/dataset/186/wine+quality. I downloaded the red and white data separately and concatenated them. Fortunately, there is no missing data and the data is fairly clean and ready for analysis. There is more white wine data than red wine data. 

```{r setup, include=FALSE}
setwd("/Users/zcurtis/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/bios 611/611_project")
library(tidyr)
library(dplyr)
library(ggplot2)
library(corrplot)
library(glmnet) #maybe
library(ggrepel) #maybe

white<-read.csv("winequality-white.csv", sep=';')%>%
  mutate(type="white")%>%
  select(type, everything())
red<-read.csv("winequality-red.csv", sep=';')%>%
  mutate(type="red")%>%
  select(type,everything())

#check matching vars before merging 
sum(names(red)==names(white))

allwine<-rbind(white,red)

#pivot data 
pivwine<-allwine%>%
  pivot_longer(cols=2:13, names_to="quality", values_to="value")

#some summary data at a glance 
summary(red)
summary(white)
``` 

```{r visualization, include=TRUE}
# Reshape data
long_wine <- allwine %>%
  pivot_longer(cols = -c(type, quality), names_to = "variable", values_to = "value")

# Plot density (smoothed distribution)
ggplot(long_wine, aes(x = value, fill = type)) +
  geom_density(
    alpha = 0.6,
    position = "identity"
  ) +
  facet_wrap(~ variable, scales = "free") +   # ‚Üê Changed from "free_x" to "free"
  labs(
    y = "Density",
    x = "Value",
    title = "Distribution of Wine Characteristics by Type"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"))
```
From this, we can see initially that red wines may have a higher pH, sulfates, and volatile acidity than white wines. White wines may have more variation in residual sugar and higher  sulfur dioxide than red wines.   
```{r corplot}
# Correlation matrix
mycor <- cor(allwine[,-1])
corrplot(mycor, type = "upper", order = "hclust", tl.col = "black")
```
We can see here that alcohol and density are highly NEGATIVELY correlated, makes sense since the higher the alcohol content, the lower the density.   
  
Additionally, total sulfur dioxide and free sulfur dioxide also highly correlated, which makes sense because they are different measures of the same thing. Moving forward, we could keep one, since using two highly correlated variables in many analyses is an issue.    

```{r PCA, include=TRUE}
results<-prcomp(allwine[-1], center=TRUE, scale=TRUE)
rx <- results$x
rx_df <- as_tibble(rx) %>%
  mutate(row = row_number()) %>%
  pivot_longer(cols = -row, names_to = "pc", values_to = "value") %>%
  mutate(pc = suppressWarnings(as.numeric(gsub("^[^0-9]*", "", pc))))

summary(results)

var_explained <- results$sdev^2 / sum(results$sdev^2)
scree_df <- data.frame(
  PC = 1:length(var_explained),
  Variance = var_explained
)

ggplot(scree_df, aes(x = PC, y = Variance)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Scree Plot: Variance Explained by Each PC",
    y = "Proportion of Variance Explained"
  ) +
  scale_x_continuous(breaks = 1:ncol(allwine[-1])) +
  theme_minimal()

scores <- as.data.frame(results$x[,1:2])
scores$type <- allwine$type 

ggplot(scores, aes(x = PC1, y = PC2, color=type)) +
  geom_point(size = 1.5, alpha=0.3) +
  #geom_text_repel(size = 3, max.overlaps = 50, color = "navy") +
  theme_minimal() 
```
I was planning to do kmeans if there was obvious clustering that appears, but as seen in this plot, there is overlap and not tight separate clusters in the data. 
Red and white wines are distinct in terms of PC1, but not distinct in terms of PC2. There is much more overlap on the Y axis between the types. Thus PC1 captures more of the chemical differences in the types of wines. 

Let's continue by investigating the loadings of the first two PCs: 
```{r pc cont}
pcs<-as.data.frame(results$rotation)[,1:2]
pcs
```
It appears that PC1 encompasses wines with higher volatile acidity, low sulfur dioxide, higher sulphates, and lower residual sugar. On the other hand, PC2 encompasses wines with higher citric acid, residual sugar, sulfur dioxide, density, and lower alcohol. 

As red wines are fermented, this might make sense for them to have higher sulphates and for white wines to have higher sugars(white wines lie on the negative side, red on the positive side of the PC1 plot).

```{r pc cont2}
loadings <- as.data.frame(results$rotation[, 1:2])
loadings$variable <- rownames(loadings)

ggplot(loadings, aes(x = PC1, y = PC2, label = variable)) +
  geom_point(color = "darkseagreen4", size = 3) +
  geom_text_repel(aes(label = variable), size = 3) +
  labs(title = "PCA Loadings: Contribution of Variables to PC1 & PC2") +
  theme_minimal() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50")
```
This plot is a more intuitive way of understanding the contributions of chemical compounds to the two PCs. We see PC1 has positive contributions from density, fixed acidity, chlorides, sulphates, and volatile acidity. PC2 on the other hand has positive contributions from every factor except quality, alcohol, and pH.   

I am curious if we can use the chemical properties to predict alcohol content. I will do a LASSO regression, using 70% of the data to train the model, and test it on the other 30% of the data. 
```{r regnew}
set.seed(827)
y<-allwine$alcohol
x<-model.matrix(alcohol ~. -type -quality, data=allwine)
n<-nrow(allwine)
train_idx <- sample(1:n, 0.7 * n)
xtrain<-x[train_idx, ]
ytrain<-y[train_idx]
xtest<-x[-train_idx, ]
ytest<-y[-train_idx]

#use training data for model 
cv_model<-cv.glmnet(xtrain,ytrain)
best_lambda <- cv_model$lambda.min
#make predictions on test 
y_pred_test <- predict(cv_model, s = best_lambda, newx = xtest)
#calculate R^2 from test 
sse <- sum((ytest - y_pred_test)^2)  
sst <- sum((ytest - mean(ytest))^2) 
rsq_test <- 1 - sse/sst
print(rsq_test)
```
An $R^2$ value of 0.823 indicates that about 83% of the variation in alcohol content can be predicted by the other numeric chemical properties. 

