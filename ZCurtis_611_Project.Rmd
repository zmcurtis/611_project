---
title: "611 Project--Wine Quality Analysis"
author: "Zoe Curtis"
date: "2025-09-30"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
setwd("/Users/zcurtis/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/bios 611/611_project")
library(tidyr)
library(dplyr)
library(ggplot2)
library(corrplot)
library(glmnet) #maybe
library(ggrepel) #maybe

white<-read.csv("winequality-white.csv", sep=';')%>%
  mutate(type="white")%>%
  select(type, everything())
red<-read.csv("winequality-red.csv", sep=';')%>%
  mutate(type="red")%>%
  select(type,everything())

#check matching vars before merging 
sum(names(red)==names(white))

allwine<-rbind(white,red)

#pivot data 
pivwine<-allwine%>%
  pivot_longer(cols=2:13, names_to="quality", values_to="value")

#some summary data at a glance 
summary(red)
summary(white)
``` 

``` {r exploratory, include=FALSE}}
#thinking: want to see how these qualities vary for red vs white wine
#or: more interesting, could look at just white wine and try to cluster and see if you can pick out types of white wine 

#some visualization 
#make bar charts (proportion per type of wine) for each explantory variable to get a feel 
library(ggplot2)
library(dplyr)
library(tidyr)

# Step 1: Reshape data (pivot all numeric columns except 'type')
# Assuming your first column is 'type' (wine type: red/white)
# If your type column has a different name, replace "type" accordingly

long_wine <- allwine %>%
  pivot_longer(cols = -type, names_to = "variable", values_to = "value")

ggplot(long_wine, aes(x = value, fill = type, group = type)) +
  geom_histogram(
    aes(y = after_stat(count / sum(count))),
    bins = 30,
    alpha = 0.7,
    position = "dodge"
  ) +
  facet_wrap(~ variable, scales = "free_x") +  
  labs(
    y = "Proportion within wine type",
    x = "Value",
    title = "Distribution of Wine Characteristics by Type"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"))

#try something else: 
long_white <- white %>%
  pivot_longer(cols = -type, names_to = "variable", values_to = "value")

ggplot(long_white, aes(x = value, fill = type, group = type)) +
  geom_histogram(
    aes(y = after_stat(count / sum(count))),
    bins = 30,
    alpha = 0.7,
    position = "dodge"
  ) +
  facet_wrap(~ variable, scales = "free_x") +  
  labs(
    y = "Proportion within wine type",
    x = "Value",
    title = "Distribution of Wine Characteristics by Type"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"))

long_red <- red %>%
  pivot_longer(cols = -type, names_to = "variable", values_to = "value")

ggplot(long_red, aes(x = value, fill = type, group = type)) +
  geom_histogram(
    aes(y = after_stat(count / sum(count))),
    bins = 30,
    alpha = 0.7,
    position = "dodge"
  ) +
  facet_wrap(~ variable, scales = "free_x") +  
  labs(
    y = "Proportion within wine type",
    x = "Value",
    title = "Distribution of Wine Characteristics by Type"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"))


# for (i in names(allwine)) {
#   if (is.numeric(allwine[[i]])) {
#     p <- ggplot(allwine, aes_string(x = i, fill = "type")) +
#       geom_histogram(position = "dodge", bins = 30)
#   }
# }

#else {
#     p <- ggplot(allwine, aes_string(x = i, fill = "type")) +
#       geom_bar(position = "dodge")
#   }
#   p <- p + ggtitle(paste("Distribution of", i)) + theme_minimal()
#   print(p)
# }


#exploring
#white wine only pca
results<-prcomp(white[-1], center=TRUE, scale=TRUE)


screeplot(results, type="line") #elbow at 2

scores <- as.data.frame(results$x[,1:2])
scores$type <- white$type 

ggplot(scores, aes(x = PC1, y = PC2)) +
  geom_point(size = 1.5) +
  #geom_text_repel(size = 3, max.overlaps = 50, color = "navy") +
  theme_minimal() 

mycor<-cor(white[,-1])
corrplot(mycor, type = "upper", order = "hclust", tl.col = "black")

#red wine only pca 
results<-prcomp(red[-1], center=TRUE, scale=TRUE)


screeplot(results, type="line") #no good elbow

scores <- as.data.frame(results$x[,1:2])
scores$type <- red$type 

ggplot(scores, aes(x = PC1, y = PC2)) +
  geom_point(size = 1.5) +
  #geom_text_repel(size = 3, max.overlaps = 50, color = "navy") +
  theme_minimal() 

mycor<-cor(red[,-1])
corrplot(mycor, type = "upper", order = "hclust", tl.col = "black")

pcs<-as.data.frame(results$rotation)[,1:2]
pcs

#all wine pca
results<-prcomp(allwine[-1], center=TRUE, scale=TRUE)
rx <- results$x
rx_df <- as_tibble(rx) %>%
  mutate(row = row_number()) %>%
  pivot_longer(cols = -row, names_to = "pc", values_to = "value") %>%
  mutate(pc = suppressWarnings(as.numeric(gsub("^[^0-9]*", "", pc))))

ggplot(rx_df, aes(x = pc, y = row, fill = value)) +
       geom_raster() +
       scale_y_reverse() +
       coord_fixed() +
       scale_fill_viridis_c(option = "C") +
       labs(x = "PC", y = "Row", fill = "Score") # bad, fix
summary(results)

# Better scree plot
var_explained <- results$sdev^2 / sum(results$sdev^2)
scree_df <- data.frame(
  PC = 1:length(var_explained),
  Variance = var_explained
)

ggplot(scree_df, aes(x = PC, y = Variance)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Scree Plot: Variance Explained by Each PC",
    y = "Proportion of Variance Explained"
  ) +
  scale_x_continuous(breaks = 1:ncol(allwine[-1])) +
  theme_minimal()

scores <- as.data.frame(results$x[,1:2])
scores$type <- allwine$type 

ggplot(scores, aes(x = PC1, y = PC2, color=type)) +
  geom_point(size = 1.5) +
  #geom_text_repel(size = 3, max.overlaps = 50, color = "navy") +
  theme_minimal() 

mycor<-cor(allwine[,-1])
corrplot(mycor, type = "upper", order = "hclust", tl.col = "black") #alcohol and density highly NEGATIVELY correlated, makes sense
#total sulfur dioxide and free sulfur dioxide also highly correlated, makes sense
pcs<-as.data.frame(results$rotation)[,1:2]
pcs

loadings <- as.data.frame(results$rotation[, 1:2])
loadings$variable <- rownames(loadings)

ggplot(loadings, aes(x = PC1, y = PC2, label = variable)) +
  geom_point(color = "darkseagreen4", size = 3) +
  geom_text_repel(aes(label = variable), size = 3) +
  labs(title = "PCA Loadings: Contribution of Variables to PC1 & PC2") +
  theme_minimal() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50")
#pc1 is wines with low sulfur dioxide and residual sugars, high acidity
#pc2 is wines with high density, acidity, sugar, chlorides


#maybe keep first three PCs.....
#do clustering?
#for loops for visualization


```

```{r visualization, include=TRUE}
# Reshape data
long_wine <- allwine %>%
  pivot_longer(cols = -c(type, quality), names_to = "variable", values_to = "value")

# Plot density (smoothed distribution)
ggplot(long_wine, aes(x = value, fill = type)) +
  geom_density(
    alpha = 0.6,
    position = "identity"
  ) +
  facet_wrap(~ variable, scales = "free") +   # ‚Üê Changed from "free_x" to "free"
  labs(
    y = "Density",
    x = "Value",
    title = "Distribution of Wine Characteristics by Type"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"))
```
From this, we can see initially that red wines may have a higher pH, sulfates, and volatile acidity than white wines. White wines may have more variation in residual sugar and higher  sulfur dioxide than red wines.   
```{r corplot}
# Correlation matrix
mycor <- cor(allwine[,-1])
corrplot(mycor, type = "upper", order = "hclust", tl.col = "black")
```
We can see here that alcohol and density are highly NEGATIVELY correlated, makes sense since the higher the alcohol content, the lower the density.   
  
Additionally, total sulfur dioxide and free sulfur dioxide also highly correlated, which makes sense because they are different measures of the same thing. Moving forward, we could keep one, since using two highly correlated variables in many analyses is an issue.    

```{r PCA, include=TRUE}
results<-prcomp(allwine[-1], center=TRUE, scale=TRUE)
rx <- results$x
rx_df <- as_tibble(rx) %>%
  mutate(row = row_number()) %>%
  pivot_longer(cols = -row, names_to = "pc", values_to = "value") %>%
  mutate(pc = suppressWarnings(as.numeric(gsub("^[^0-9]*", "", pc))))

summary(results)

var_explained <- results$sdev^2 / sum(results$sdev^2)
scree_df <- data.frame(
  PC = 1:length(var_explained),
  Variance = var_explained
)

ggplot(scree_df, aes(x = PC, y = Variance)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Scree Plot: Variance Explained by Each PC",
    y = "Proportion of Variance Explained"
  ) +
  scale_x_continuous(breaks = 1:ncol(allwine[-1])) +
  theme_minimal()

scores <- as.data.frame(results$x[,1:2])
scores$type <- allwine$type 

ggplot(scores, aes(x = PC1, y = PC2, color=type)) +
  geom_point(size = 1.5) +
  #geom_text_repel(size = 3, max.overlaps = 50, color = "navy") +
  theme_minimal() 

pcs<-as.data.frame(results$rotation)[,1:2]
pcs

loadings <- as.data.frame(results$rotation[, 1:2])
loadings$variable <- rownames(loadings)

ggplot(loadings, aes(x = PC1, y = PC2, label = variable)) +
  geom_point(color = "darkseagreen4", size = 3) +
  geom_text_repel(aes(label = variable), size = 3) +
  labs(title = "PCA Loadings: Contribution of Variables to PC1 & PC2") +
  theme_minimal() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50")
```

```{r clustering, include=TRUE}
#use kmeans to tease out clusters in the data 
library(cluster)
clusGap(allwine[,-1], kmeans, K.max=4, nstart=20, iter.max=40)
```

```{r alc regression}
#maybe look into predicting alcohol with other vars? 
#maybe use the pca from earlier 
y<-as.matrix(allwine$alcohol)
x<-as.matrix(allwine%>%select(-alcohol))
cv_model <- cv.glmnet(x, y, alpha = 1)

#find optimal lambda value that minimizes test MSE
best_lambda <- cv_model$lambda.min
best_lambda

best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)
coef(best_model)

#my best predictors are volatile acidity, pH and sulphates, interesting!!

y_predicted <- predict(best_model, s = best_lambda, newx = x)

#find SST and SSE
sst <- sum((y - mean(y))^2)
sse <- sum((y_predicted - y)^2)

#find R-Squared
rsq <- 1 - sse/sst
rsq

#make predictions? and plots? artificially change some predictor var, and then plot them with varying other explanatory var, put predicted alc on y 
```
About 80% of the variation in alcohol level can be predicted by ....   
```{r}
#predict type? see what helps there?
allwine$type<-as.factor(allwine$type)
typereg<-glm(type~fixed.acidity+volatile.acidity+citric.acid+residual.sugar+chlorides+free.sulfur.dioxide+total.sulfur.dioxide+density+pH+alcohol+sulphates+quality, data=allwine, family="binomial")
summary(typereg)
#gives us everything but fixed acidity and pH) 
#try with previous PCs? 
typereg2<-glm(allwine$type~pcs$PC1, family="binomial") #figure this out 
summary(typereg2)
```


